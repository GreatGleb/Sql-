Лабораторна робота №4
Оператор WITH та процедури:

1)
with MostExpensiveDue as (select MAX(TotalDue) as max from SalesLT.SalesOrderHeader)
select Customer.NameStyle, Customer.CompanyName, Customer.FirstName, Customer.LastName, SalesOrderHeader.OrderDate, SalesOrderHeader.TotalDue
from SalesLT.SalesOrderHeader, SalesLT.Customer, MostExpensiveDue
where SalesOrderHeader.CustomerID=Customer.CustomerID and SalesOrderHeader.TotalDue=MostExpensiveDue.max

2)
DECLARE @maxTotal FLOAT
set @maxTotal = (select MAX(TotalDue) as max from SalesLT.SalesOrderHeader)
select Customer.FirstName, Customer.LastName,Customer.CompanyName, SalesOrderHeader.OrderDate, SalesOrderHeader.TotalDue
from SalesLT.SalesOrderHeader INNER join SalesLT.Customer
on SalesOrderHeader.CustomerID = Customer.CustomerID
where SalesOrderHeader.TotalDue = @maxTotal

3)
with Dater(City, year, month, LineTotal) as
(
select A.City, year(H.DueDate), month(H.DueDate), D.LineTotal
from SalesLT.SalesOrderHeader H inner join SalesLT.SalesOrderDetail D
on H.SalesOrderID = D.SalesOrderDetailID inner join SalesLt.Address A
on H.BillToAddressID=A.AddressID
where H.DueDate > '2011/12/31'
union all 
select A.City, year(H.DueDate), month(H.DueDate), D.LineTotal
from SalesLT.SalesOrderHeader H inner join SalesLT.SalesOrderDetail D
on H.SalesOrderID = D.SalesOrderDetailID inner join SalesLt.Address A
on H.BillToAddressID=A.AddressID
inner join Dater as t on D.LineTotal=t.LineTotal
where H.DueDate < '2013/01/01'
)

select City, year, month, LineTotal
from Dater
order by month

4)
CREATE PROCEDURE Expensive_Orders_in_Delivery_Services @DATE_BEG AS DATE, @DATE_END AS DATE 
AS
select top(10) H.ShipMethod as 'Служба доставки', H.SalesOrderNumber as 'Номер заказа', H.OrderDate as 'Дата Заказа', D.LineTotal as 'Сумма' 
from SalesLT.SalesOrderHeader H LEFT join SalesLT.SalesOrderDetail d 
on h.SalesOrderID = d.SalesOrderID  
where H.OrderDate > @DATE_BEG and H.OrderDate < @DATE_END
group by h.ShipMethod, h.SalesOrderNumber, h.OrderDate, d.LineTotal
order by d.LineTotal DESC
GO